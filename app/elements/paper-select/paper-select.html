<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt

Copyright (c) 2015 Cu3PO42. Modifications from the original code found at https://github.com/PolymerElements/iron-dropdown/tree/master/demo
distributed under MIT license.
-->

<link rel="import" href="../../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../expand-animation/expand-animation.html">

<dom-module id="paper-select">
    <style>
        :host {
            display: block;
        }

        .button-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .button-content > * {
            display: block;
        }

        .button-content span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-transform: none;
        }

        .button-content iron-icon {
            flex-shrink: 0;
        }

        iron-dropdown {
            margin: 0.5em 0.29em 0;
        }

        ul {
            display: block;
            position: relative;
            background-color: #fff;
            box-shadow: 0px 2px 6px #ccc;
            margin: 0.25em 0;
            padding: 0;
            border-radius: 3px;
            max-height: calc(10.5em + 3px) !important;
            line-height: 1.5em;
        }

        [vertical-align="top"] ul {
            margin-top: 0;
        }

        [vertical-align="bottom"] ul {
            margin-bottom: 0;
        }

        li {
            display: block;
            position: relative;
            padding: 0 0.25em 0;
        }

        li:first-of-type {
            padding-top: 0.25em;
        }

        li:last-of-type {
            padding-bottom: 0.25em;
        }

        li div {
            display: block;
            position: relative;
            padding: 0.5em;
            text-decoration: none;
            cursor: pointer;
            text-overflow: ellipsis;
        }

        li:hover, ul:not(:hover) li.iron-selected {
            background-color: var(--accent-color);
            color: var(--text-primary-color);
        }

        li:not(:last-of-type) {
            border-bottom: 1px solid #eee;
        }
    </style>
    <template>
        <paper-button raised on-tap="open" id="button"><div class="button-content"><span>{{getElement(items, selected)}}</span><iron-icon icon="{{icon}}"></iron-icon></div></paper-button>
        <div id="dropdownContainer">
            <iron-dropdown id="dropdown"
                disabled="[[disabled]]"
                opened="{{opened}}"
                open-animation-config="[[openAnimationConfig]]"
                close-animation-config="[[closeAnimationConfig]]">
                <ul on-tap="close" class="dropdown-content">
                    <iron-selector selected="{{selected}}">
                        <template is="dom-repeat" items="{{items}}">
                            <li><div>{{item}}</div></li>
                        </template>
                    </iron-selector>
                </ul>
            </iron-dropdown>
        </div>
    </template>
    <script>
        Polymer({
            is: 'paper-select',

            properties: {
                verticalAlign: String,
                horizontalAlign: String,
                disabled: Boolean,
                openAnimationConfig: {
                    type: Array,
                    value: function() {
                        return [{
                            name: 'fade-in-animation',
                            timing: {
                                delay: 150,
                                duration: 50
                            }
                        }, {
                            name: 'expand-animation',
                            timing: {
                                delay: 150,
                                duration: 200
                            }
                        }];
                    }
                },

                closeAnimationConfig: {
                    type: Array,
                    value: function() {
                        return [{
                            name: 'fade-out-animation',
                            timing: {
                                duration: 200
                            }
                        }];
                    }
                },

                items: {
                    type: Array,
                    observer: 'itemsChanged'
                },
                selected: {
                    type: Number,
                    value: 0,
                    notify: true
                },

                icon: {
                    type: String,
                    computed: 'computeCurrentIcon(opened)'
                },

                opened: {
                    type: Boolean,
                    value: false
                },

                resize: {
                    type: Boolean,
                    value: false
                }
            },

            open: function() {
                this.$.dropdown.open();
            },

            close: function() {
                this.$.dropdown.close();
            },

            getElement: function(e, i) {
                return e[i];
            },

            computeCurrentIcon: function(opened) {
                return opened ? "icons:arrow-drop-up" : "icons:arrow-drop-down";
            },

            // TODO Check width of host
            setWidth: function() {
                var maxLength = 0;
                for (var i = 0; i < this.items.length; ++i) {
                    if (this.items[i].length > maxLength)
                        maxLength = this.items[i].length;
                }

                maxLength = Math.min(15, maxLength);

                this.$.dropdown.style.width = this.$.button.style.width = maxLength + "em";
            },

            attached: function() {
                this.setWidth();
            },

            itemsChanged: function(newValue, oldValue) {
                if (newValue.length <= this.selected && newValue.length > 0) {
                    this.selected = newValue.length-1;
                }
                if (this.resize) {
                    this.setWidth();
                }
            }
        });
    </script>
</dom-module>
